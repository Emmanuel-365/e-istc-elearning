{% extends "base.html" %}

{% block title %}Détails du Cours - {{ course.title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'administration:course_management' %}">Gestion des Cours</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ course.title }}</li>
        </ol>
    </nav>

    <h2 class="mb-4">{{ course.title }}</h2>

    <div class="card mb-4">
        <div class="card-header">
            Informations sur le Cours
        </div>
        <div class="card-body">
            <p><strong>Titre :</strong> {{ course.title }}</p>
            <p><strong>Description :</strong> {{ course.description }}</p>
            <p><strong>Enseignant :</strong> {{ course.teacher.first_name }} {{ course.teacher.last_name }}</p>
            <p><strong>Date de Création :</strong> {{ course.created_at|date:"d/m/Y H:i" }}</p>
            <p><strong>Dernière mise à jour :</strong> {{ course.updated_at|date:"d/m/Y H:i" }}</p>
            <p><strong>Lien de la visioconférence :</strong> {{ course.visio_link|default:"Non défini" }}</p>
        </div>
    </div>

    <h3>Modules du Cours</h3>
    <div class="card">
        <div class="card-header">
            <button id="addModuleBtn" class="btn btn-primary">Ajouter un module</button>
        </div>
        <div class="card-body">
            <ul class="list-group" id="module-list">
                {% for module in course.modules.all %}
                <li class="list-group-item d-flex justify-content-between align-items-center" id="module-item-{{ module.id }}">
                    <div>
                        <h5>{{ module.title }} (Ordre: {{ module.order }})</h5>
                        <p>{{ module.description }}</p>
                        <h6>Ressources:</h6>
                        <ul class="list-group list-group-flush" id="ressource-list-{{ module.id }}">
                            {% for ressource in module.ressources.all %}
                            <li class="list-group-item d-flex justify-content-between align-items-center" id="ressource-item-{{ ressource.id }}">
                                {{ ressource.title }}
                                <div>
                                    {% if ressource.file %}
                                        <a href="{{ ressource.file.url }}" target="_blank" class="btn btn-sm btn-info">Voir Fichier</a>
                                    {% endif %}
                                    {% if ressource.url %}
                                        <a href="{{ ressource.url }}" target="_blank" class="btn btn-sm btn-info">Voir URL</a>
                                    {% endif %}
                                    <button class="btn btn-sm btn-secondary edit-ressource-btn" data-id="{{ ressource.id }}" data-module-id="{{ module.id }}">Modifier</button>
                                    <button class="btn btn-sm btn-danger delete-ressource-btn" data-id="{{ ressource.id }}">Supprimer</button>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        <button class="btn btn-sm btn-success mt-2 add-ressource-btn" data-module-id="{{ module.id }}">Ajouter Ressource</button>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-secondary edit-module-btn" data-id="{{ module.id }}">Modifier</button>
                        <button class="btn btn-sm btn-danger delete-module-btn" data-id="{{ module.id }}">Supprimer</button>
                    </div>
                </li>
                {% empty %}
                <li class="list-group-item">Aucun module pour ce cours pour le moment.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <h3>Évaluations</h3>
    <div class="card mb-4">
        <div class="card-header">
            <button id="addEvaluationBtn" class="btn btn-primary">Ajouter une évaluation</button>
        </div>
        <div class="card-body">
            <ul class="list-group" id="evaluation-list">
                {% for activite in activites %}
                <li class="list-group-item d-flex justify-content-between align-items-center" id="evaluation-item-{{ activite.id }}">
                    <div>
                        <h5>{{ activite.title }} <span class="badge bg-info">{{ activite.get_activity_type_display }}</span></h5>
                        <p>{{ activite.description }}</p>
                        <small>Date limite: {{ activite.due_date|date:"d/m/Y H:i" }}</small>
                    </div>
                    <div>
                        {% if activite.activity_type == 'QUIZ' %}
                            <button class="btn btn-sm btn-info manage-questions-btn" data-id="{{ activite.id }}">Gérer les questions</button>
                        {% elif activite.activity_type == 'DEVOIR' %}
                            <button class="btn btn-sm btn-warning grade-assignment-btn" data-id="{{ activite.id }}">Noter les devoirs</button>
                        {% endif %}
                        <button class="btn btn-sm btn-secondary edit-evaluation-btn" data-id="{{ activite.id }}">Modifier</button>
                        <button class="btn btn-sm btn-danger delete-evaluation-btn" data-id="{{ activite.id }}">Supprimer</button>
                    </div>
                </li>
                {% empty %}
                <li class="list-group-item">Aucune évaluation pour ce cours pour le moment.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <h3>Étudiants inscrits</h3>
    <div class="card mb-4">
        <div class="card-header">
            <button id="enrollStudentBtn" class="btn btn-primary">Inscrire un étudiant</button>
            <a href="{% url 'administration:course_progress' course.id %}" class="btn btn-info">Voir la Progression</a>
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Matricule</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="student-table-body">
                    {% for student in enrolled_students %}
                    <tr id="student-row-{{ student.id }}">
                        <td>{{ student.last_name }} {{ student.first_name }}</td>
                        <td>{{ student.email }}</td>
                        <td>{{ student.matricule }}</td>
                        <td>
                            <a href="{% url 'messaging:new_conversation' student.id %}" class="btn btn-sm btn-outline-primary">Contacter</a>
                            <button class="btn btn-sm btn-danger remove-student-btn" data-id="{{ student.id }}">Retirer</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr id="no-student-row">
                        <td colspan="4">Aucun étudiant inscrit.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <h3>Forum du Cours</h3>
    <div class="card mb-4">
        <div class="card-body">
            <p>Espace de discussion pour ce cours.</p>
            <a href="{% url 'forums:forum_cours' course.id %}" class="btn btn-primary">Accéder au Forum</a>
        </div>
    </div>

    <h3>Annonces</h3>
    <div class="card mb-4">
        <div class="card-header">
            <button id="addAnnonceBtn" class="btn btn-primary">Ajouter une annonce</button>
        </div>
        <div class="card-body">
            <ul class="list-group" id="annonce-list">
                {% for annonce in annonces %}
                <li class="list-group-item d-flex justify-content-between align-items-center" id="annonce-item-{{ annonce.id }}">
                    <div>
                        <h5>{{ annonce.titre }}</h5>
                        <p>{{ annonce.contenu|linebreaksbr }}</p>
                        <small>Publié le: {{ annonce.cree_le|date:"d/m/Y H:i" }}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-secondary edit-annonce-btn" data-id="{{ annonce.id }}">Modifier</button>
                        <button class="btn btn-sm btn-danger delete-annonce-btn" data-id="{{ annonce.id }}">Supprimer</button>
                    </div>
                </li>
                {% empty %}
                <li class="list-group-item">Aucune annonce pour ce cours pour le moment.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Modal pour Inscrire un Étudiant -->
    <div class="modal fade" id="enrollStudentModal" tabindex="-1" aria-labelledby="enrollStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="enrollStudentModalLabel">Inscrire un Étudiant</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group" id="enrollable-student-list">
                        <!-- La liste des étudiants non-inscrits sera chargée ici -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour Ajouter/Modifier Annonce -->
    <div class="modal fade" id="annonceModal" tabindex="-1" aria-labelledby="annonceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="annonceModalLabel">Ajouter une annonce</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="annonceForm">
                        <input type="hidden" id="annonceId" name="annonceId">
                        <div id="annonce-form-errors" class="alert alert-danger d-none"></div>
                        
                        <div class="mb-3">
                            <label for="annonceTitre" class="form-label">Titre</label>
                            <input type="text" class="form-control" id="annonceTitre" name="titre" required>
                        </div>
                        <div class="mb-3">
                            <label for="annonceContenu" class="form-label">Contenu</label>
                            <textarea class="form-control" id="annonceContenu" name="contenu" rows="4" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" id="saveAnnonceBtn" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Sauvegarder
                </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour Ajouter/Modifier Module -->
    <div class="modal fade" id="moduleModal" tabindex="-1" aria-labelledby="moduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="moduleModalLabel">Ajouter un module</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="moduleForm">
                        <input type="hidden" id="moduleId" name="moduleId">
                        <div id="module-form-errors" class="alert alert-danger d-none"></div>
                        
                        <div class="mb-3">
                            <label for="moduleTitle" class="form-label">Titre</label>
                            <input type="text" class="form-control" id="moduleTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="moduleDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="moduleDescription" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="moduleOrder" class="form-label">Ordre</label>
                            <input type="number" class="form-control" id="moduleOrder" name="order" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" id="saveModuleBtn" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Sauvegarder
                </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour Ajouter/Modifier Ressource -->
    <div class="modal fade" id="ressourceModal" tabindex="-1" aria-labelledby="ressourceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ressourceModalLabel">Ajouter une ressource</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="ressourceForm" enctype="multipart/form-data">
                        <input type="hidden" id="ressourceId" name="ressourceId">
                        <input type="hidden" id="ressourceModuleId" name="ressourceModuleId">
                        <div id="ressource-form-errors" class="alert alert-danger d-none"></div>
                        
                        <div class="mb-3">
                            <label for="ressourceTitle" class="form-label">Titre</label>
                            <input type="text" class="form-control" id="ressourceTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="ressourceFile" class="form-label">Fichier</label>
                            <input type="file" class="form-control" id="ressourceFile" name="file">
                        </div>
                        <div class="mb-3">
                            <label for="ressourceUrl" class="form-label">URL</label>
                            <input type="url" class="form-control" id="ressourceUrl" name="url">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" id="saveRessourceBtn" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Sauvegarder
                </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmation de Suppression (Module/Ressource) -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmer la suppression</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer cet élément ? Cette action est irréversible.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Supprimer
                </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour Ajouter/Modifier Évaluation -->
    <div class="modal fade" id="evaluationModal" tabindex="-1" aria-labelledby="evaluationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="evaluationModalLabel">Ajouter une évaluation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="evaluationForm">
                        <input type="hidden" id="evaluationId" name="evaluationId">
                        <div id="evaluation-form-errors" class="alert alert-danger d-none"></div>
                        
                        <div class="mb-3">
                            <label for="evaluationTitle" class="form-label">Titre</label>
                            <input type="text" class="form-control" id="evaluationTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="evaluationDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="evaluationDescription" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="evaluationType" class="form-label">Type</label>
                            <select class="form-select" id="evaluationType" name="activity_type" required>
                                <option value="DEVOIR">Devoir</option>
                                <option value="QUIZ">Quiz</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="evaluationDueDate" class="form-label">Date Limite</label>
                            <input type="datetime-local" class="form-control" id="evaluationDueDate" name="due_date">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" id="saveEvaluationBtn" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Sauvegarder
                </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour Gérer les Questions d'un Quiz -->
    <div class="modal fade" id="questionsModal" tabindex="-1" aria-labelledby="questionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="questionsModalLabel">Gérer les Questions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5">
                            <h5>Ajouter/Modifier une Question</h5>
                            <form id="questionForm">
                                <input type="hidden" id="questionId" name="questionId">
                                <input type="hidden" id="quizId" name="quizId">
                                <div id="question-form-errors" class="alert alert-danger d-none"></div>
                                <div class="mb-3">
                                    <label for="questionIntitule" class="form-label">Intitulé de la question</label>
                                    <textarea class="form-control" id="questionIntitule" name="intitule" rows="3" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="questionType" class="form-label">Type de question</label>
                                    <select class="form-select" id="questionType" name="type_question">
                                        <option value="UNIQUE">Choix Unique</option>
                                        <option value="MULTIPLE">Choix Multiple</option>
                                    </select>
                                </div>
                                <hr>
                                <h6>Choix de réponse</h6>
                                <div id="choices-container">
                                    <!-- Les choix seront ajoutés ici par JS -->
                                </div>
                                <button type="button" id="addChoiceBtn" class="btn btn-sm btn-success mt-2">Ajouter un choix</button>
                                <div class="mt-3">
                                    <button type="submit" id="saveQuestionBtn" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Sauvegarder la question
                </button>
                                    <button type="button" id="clearQuestionFormBtn" class="btn btn-secondary">Nouvelle Question</button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-7">
                            <h5>Questions du Quiz</h5>
                            <ul class="list-group" id="question-list-in-modal">
                                <!-- La liste des questions sera chargée ici -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour Noter les Devoirs -->
    <div class="modal fade" id="gradeAssignmentModal" tabindex="-1" aria-labelledby="gradeAssignmentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gradeAssignmentModalLabel">Noter les Devoirs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6 id="assignmentTitleForGrading"></h6>
                    <div id="submissionsList">
                        <!-- Les soumissions seront chargées ici par JS -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('Script course_detail_page.html chargé.');
    const courseId = "{{ course.id }}";
    const moduleModal = document.getElementById('moduleModal') ? new bootstrap.Modal(document.getElementById('moduleModal')) : null;
    const ressourceModal = document.getElementById('ressourceModal') ? new bootstrap.Modal(document.getElementById('ressourceModal')) : null;
    const deleteConfirmModal = document.getElementById('deleteConfirmModal') ? new bootstrap.Modal(document.getElementById('deleteConfirmModal')) : null;
    const evaluationModal = document.getElementById('evaluationModal') ? new bootstrap.Modal(document.getElementById('evaluationModal')) : null;
    const questionsModal = document.getElementById('questionsModal') ? new bootstrap.Modal(document.getElementById('questionsModal')) : null;
    const gradeAssignmentModal = document.getElementById('gradeAssignmentModal') ? new bootstrap.Modal(document.getElementById('gradeAssignmentModal')) : null;
    const annonceModal = document.getElementById('annonceModal') ? new bootstrap.Modal(document.getElementById('annonceModal')) : null;
    const enrollStudentModal = document.getElementById('enrollStudentModal') ? new bootstrap.Modal(document.getElementById('enrollStudentModal')) : null;

    const moduleForm = document.getElementById('moduleForm');
    const ressourceForm = document.getElementById('ressourceForm');
    const evaluationForm = document.getElementById('evaluationForm');
    const annonceForm = document.getElementById('annonceForm');

    const addModuleBtn = document.getElementById('addModuleBtn');
    const saveModuleBtn = document.getElementById('saveModuleBtn');
    const saveRessourceBtn = document.getElementById('saveRessourceBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const addEvaluationBtn = document.getElementById('addEvaluationBtn');
    const saveEvaluationBtn = document.getElementById('saveEvaluationBtn');
    const addAnnonceBtn = document.getElementById('addAnnonceBtn');
    const saveAnnonceBtn = document.getElementById('saveAnnonceBtn');
    const enrollStudentBtn = document.getElementById('enrollStudentBtn');

    const moduleList = document.getElementById('module-list');
    const studentTableBody = document.getElementById('student-table-body');
    const evaluationList = document.getElementById('evaluation-list');
    const annonceList = document.getElementById('annonce-list');

    let currentModuleId = null;
    let currentRessourceId = null;
    let currentEvaluationId = null;
    let currentAnnonceId = null;
    let deleteElementType = null; // 'module', 'ressource', 'evaluation' ou 'annonce'

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- Gestion des Évaluations ---
    addEvaluationBtn.addEventListener('click', function () {
        currentEvaluationId = null;
        evaluationForm.reset();
        document.getElementById('evaluationModalLabel').textContent = 'Ajouter une évaluation';
        document.getElementById('evaluation-form-errors').classList.add('d-none');
        evaluationModal.show();
    });

    saveEvaluationBtn.addEventListener('click', function () {
        // Client-side validation
        if (!evaluationForm.checkValidity()) {
            evaluationForm.reportValidity();
            return;
        }

        const spinner = saveEvaluationBtn.querySelector('.spinner-border');
        spinner.classList.remove('d-none');
        saveEvaluationBtn.disabled = true;

        const formData = new FormData(evaluationForm);
        const data = Object.fromEntries(formData.entries());
        const url = currentEvaluationId
            ? `/evaluations/api/activities/${currentEvaluationId}/update/`
            : `/evaluations/api/courses/${courseId}/activities/create/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (response.ok) { // Check for HTTP 200-299 status
                evaluationModal.hide();
                upsertEvaluationInList(result.activite);
            } else {
                const errorDiv = document.getElementById('evaluation-form-errors');
                errorDiv.innerHTML = Object.values(result.errors).map(e => `<p>${e}</p>`).join('');
                errorDiv.classList.remove('d-none');
            }
        })
        .finally(() => {
            spinner.classList.add('d-none');
            saveEvaluationBtn.disabled = false;
        });
    });

    function upsertEvaluationInList(activite) {
        let evaluationItem = document.getElementById(`evaluation-item-${activite.id}`);
        const evaluationHtml = `
            <div>
                <h5>${activite.title} <span class="badge bg-info">${activite.activity_type}</span></h5>
                <p>${activite.description}</p>
                <small>Date limite: ${new Date(activite.due_date).toLocaleString()}</small>
            </div>
            <div>
                ${activite.activity_type === 'Quiz' ? `<button class="btn btn-sm btn-info manage-questions-btn" data-id="${activite.id}">Gérer les questions</button>` : ''}
                ${activite.activity_type === 'Devoir' ? `<button class="btn btn-sm btn-warning grade-assignment-btn" data-id="${activite.id}">Noter les devoirs</button>` : ''}
                <button class="btn btn-sm btn-secondary edit-evaluation-btn" data-id="${activite.id}">Modifier</button>
                <button class="btn btn-sm btn-danger delete-evaluation-btn" data-id="${activite.id}">Supprimer</button>
            </div>
        `;

        if (evaluationItem) {
            evaluationItem.innerHTML = evaluationHtml;
        } else {
            evaluationItem = document.createElement('li');
            evaluationItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            evaluationItem.id = `evaluation-item-${activite.id}`;
            evaluationItem.innerHTML = evaluationHtml;
            evaluationList.appendChild(evaluationItem);
        }
    }

    evaluationList.addEventListener('click', function (e) {
        if (e.target.classList.contains('edit-evaluation-btn')) {
            const clickedButton = e.target;
            const originalButtonText = clickedButton.innerHTML;
            clickedButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            clickedButton.disabled = true;

            currentEvaluationId = e.target.dataset.id;
            fetch(`/evaluations/api/activities/${currentEvaluationId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // Django messages will handle the error display
                        return;
                    }
                    evaluationForm.reset();
                    document.getElementById('evaluationModalLabel').textContent = 'Modifier une évaluation';
                    document.getElementById('evaluation-form-errors').classList.add('d-none');
                    
                    document.getElementById('evaluationId').value = data.id;
                    document.getElementById('evaluationTitle').value = data.title;
                    document.getElementById('evaluationDescription').value = data.description;
                    document.getElementById('evaluationType').value = data.activity_type;
                    document.getElementById('evaluationDueDate').value = data.due_date ? new Date(data.due_date).toISOString().slice(0, 16) : '';
                    
                    evaluationModal.show();
                })
                .finally(() => {
                    clickedButton.innerHTML = originalButtonText;
                    clickedButton.disabled = false;
                });
        }
        if (e.target.classList.contains('delete-evaluation-btn')) {
            currentEvaluationId = e.target.dataset.id;
            deleteElementType = 'evaluation';
            deleteConfirmModal.show();
        }
    });

    evaluationList.addEventListener('click', function(e) {
        if (e.target.classList.contains('manage-questions-btn')) {
            const quizId = e.target.dataset.id;
            document.getElementById('quizId').value = quizId;
            loadQuestionsForQuiz(quizId);
            questionsModal.show();
        }
        if (e.target.classList.contains('grade-assignment-btn')) {
            const assignmentId = e.target.dataset.id;
            document.getElementById('assignmentTitleForGrading').textContent = e.target.closest('li').querySelector('h5').textContent;
            loadSubmissionsForGrading(assignmentId);
            gradeAssignmentModal.show();
        }
    });

    // --- Fonctions d'aide pour la mise à jour de l'UI ---
    function upsertModuleInList(module) {
        let moduleItem = document.getElementById(`module-item-${module.id}`);
        const moduleHtml = `
            <div>
                <h5>${module.title} (Ordre: ${module.order})</h5>
                <p>${module.description}</p>
                <h6>Ressources:</h6>
                <ul class="list-group list-group-flush" id="ressource-list-${module.id}">
                    <!-- Ressources seront ajoutées dynamiquement ou sont déjà là -->
                </ul>
                <button class="btn btn-sm btn-success mt-2 add-ressource-btn" data-module-id="${module.id}">Ajouter Ressource</button>
            </div>
            <div>
                <button class="btn btn-sm btn-secondary edit-module-btn" data-id="${module.id}">Modifier</button>
                <button class="btn btn-sm btn-danger delete-module-btn" data-id="${module.id}">Supprimer</button>
            </div>
        `;

        if (moduleItem) {
            moduleItem.innerHTML = moduleHtml;
        } else {
            moduleItem = document.createElement('li');
            moduleItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            moduleItem.id = `module-item-${module.id}`;
            moduleItem.innerHTML = moduleHtml;
            moduleList.appendChild(moduleItem);
        }
    }

    function upsertRessourceInList(ressource, moduleId) {
        const ressourceList = document.getElementById(`ressource-list-${moduleId}`);
        let ressourceItem = document.getElementById(`ressource-item-${ressource.id}`);
        const ressourceHtml = `
            ${ressource.title}
            <div>
                ${ressource.file_url ? `<a href="${ressource.file_url}" target="_blank" class="btn btn-sm btn-info">Voir Fichier</a>` : ''}
                ${ressource.url ? `<a href="${ressource.url}" target="_blank" class="btn btn-sm btn-info">Voir URL</a>` : ''}
                <button class="btn btn-sm btn-secondary edit-ressource-btn" data-id="${ressource.id}" data-module-id="${moduleId}">Modifier</button>
                <button class="btn btn-sm btn-danger delete-ressource-btn" data-id="${ressource.id}">Supprimer</button>
            </div>
        `;

        if (ressourceItem) {
            ressourceItem.innerHTML = ressourceHtml;
        } else {
            ressourceItem = document.createElement('li');
            ressourceItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            ressourceItem.id = `ressource-item-${ressource.id}`;
            ressourceItem.innerHTML = ressourceHtml;
            ressourceList.appendChild(ressourceItem);
        }
    }

    // --- Gestion des Modules ---
    addModuleBtn.addEventListener('click', function () {
        currentModuleId = null;
        moduleForm.reset();
        document.getElementById('moduleModalLabel').textContent = 'Ajouter un module';
        document.getElementById('module-form-errors').classList.add('d-none');
        moduleModal.show();
    });

    saveModuleBtn.addEventListener('click', function () {
        // Client-side validation
        if (!moduleForm.checkValidity()) {
            moduleForm.reportValidity();
            return;
        }

        const spinner = saveModuleBtn.querySelector('.spinner-border');
        spinner.classList.remove('d-none');
        saveModuleBtn.disabled = true;

        const formData = new FormData(moduleForm);
        const data = Object.fromEntries(formData.entries());
        const url = currentModuleId 
            ? `/courses/api/modules/${currentModuleId}/update/` 
            : `/courses/api/courses/${courseId}/modules/create/`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (response.ok) {
                moduleModal.hide();
                upsertModuleInList(result.module);
            } else {
                const errorDiv = document.getElementById('module-form-errors');
                errorDiv.innerHTML = Object.values(result.errors).map(e => `<p>${e}</p>`).join('');
                errorDiv.classList.remove('d-none');
            }
        })
        .finally(() => {
            spinner.classList.add('d-none');
            saveModuleBtn.disabled = false;
        });
    });

    moduleList.addEventListener('click', function (e) {
        if (e.target.classList.contains('edit-module-btn')) {
            const clickedButton = e.target;
            const originalButtonText = clickedButton.innerHTML;
            clickedButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            clickedButton.disabled = true;

            currentModuleId = e.target.dataset.id;
            fetch(`/courses/api/modules/${currentModuleId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // Django messages will handle the error display
                        return;
                    }
                    moduleForm.reset();
                    document.getElementById('moduleModalLabel').textContent = 'Modifier un module';
                    document.getElementById('module-form-errors').classList.add('d-none');
                    
                    document.getElementById('moduleId').value = data.id;
                    document.getElementById('moduleTitle').value = data.title;
                    document.getElementById('moduleDescription').value = data.description;
                    document.getElementById('moduleOrder').value = data.order;
                    
                    moduleModal.show();
                })
                .finally(() => {
                    clickedButton.innerHTML = originalButtonText;
                    clickedButton.disabled = false;
                });
        }
        if (e.target.classList.contains('delete-module-btn')) {
            currentModuleId = e.target.dataset.id;
            deleteElementType = 'module';
            deleteConfirmModal.show();
        }
    });

    // --- Gestion des Ressources ---
    moduleList.addEventListener('click', function (e) {
        if (e.target.classList.contains('add-ressource-btn')) {
            currentModuleId = e.target.dataset.moduleId;
            currentRessourceId = null;
            ressourceForm.reset();
            document.getElementById('ressourceModalLabel').textContent = 'Ajouter une ressource';
            document.getElementById('ressource-form-errors').classList.add('d-none');
            document.getElementById('ressourceModuleId').value = currentModuleId;
            ressourceModal.show();
        }
        if (e.target.classList.contains('edit-ressource-btn')) {
            const clickedButton = e.target;
            const originalButtonText = clickedButton.innerHTML;
            clickedButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            clickedButton.disabled = true;

            currentRessourceId = e.target.dataset.id;
            currentModuleId = e.target.dataset.moduleId; // Nécessaire pour upsert
            fetch(`/courses/api/ressources/${currentRessourceId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // Django messages will handle the error display
                        return;
                    }
                    ressourceForm.reset();
                    document.getElementById('ressourceModalLabel').textContent = 'Modifier une ressource';
                    document.getElementById('ressource-form-errors').classList.add('d-none');
                    
                    document.getElementById('ressourceId').value = data.id;
                    document.getElementById('ressourceModuleId').value = currentModuleId;
                    document.getElementById('ressourceTitle').value = data.title;
                    // Les champs file et url sont gérés différemment
                    document.getElementById('ressourceUrl').value = data.url || '';
                    
                    ressourceModal.show();
                })
                .finally(() => {
                    clickedButton.innerHTML = originalButtonText;
                    clickedButton.disabled = false;
                });
        }
        if (e.target.classList.contains('delete-ressource-btn')) {
            currentRessourceId = e.target.dataset.id;
            deleteElementType = 'ressource';
            deleteConfirmModal.show();
        }
    });

    saveRessourceBtn.addEventListener('click', function () {
        // Client-side validation
        if (!ressourceForm.checkValidity()) {
            ressourceForm.reportValidity();
            return;
        }

        const spinner = saveRessourceBtn.querySelector('.spinner-border');
        spinner.classList.remove('d-none');
        saveRessourceBtn.disabled = true;

        const formData = new FormData(ressourceForm);
        const url = currentRessourceId 
            ? `/courses/api/ressources/${currentRessourceId}/update/` 
            : `/courses/api/modules/${currentModuleId}/ressources/create/`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData // FormData est utilisé directement pour les fichiers
        })
        .then(response => response.json())
        .then(result => {
            if (response.ok) {
                ressourceModal.hide();
                upsertRessourceInList(result.ressource, currentModuleId);
            } else {
                const errorDiv = document.getElementById('ressource-form-errors');
                errorDiv.innerHTML = Object.values(result.errors).map(e => `<p>${e}</p>`).join('');
                errorDiv.classList.remove('d-none');
            }
        })
        .finally(() => {
            spinner.classList.add('d-none');
            saveRessourceBtn.disabled = false;
        });
    });

    // --- Gestion de la Suppression (Module/Ressource) ---
    confirmDeleteBtn.addEventListener('click', function() {
        const spinner = confirmDeleteBtn.querySelector('.spinner-border');
        spinner.classList.remove('d-none');
        confirmDeleteBtn.disabled = true;

        let url = '';
        if (deleteElementType === 'module') {
            url = `/courses/api/modules/${currentModuleId}/delete/`;
        } else if (deleteElementType === 'ressource') {
            url = `/courses/api/ressources/${currentRessourceId}/delete/`;
        } else if (deleteElementType === 'evaluation') {
            url = `/evaluations/api/activities/${currentEvaluationId}/delete/`;
        } else if (deleteElementType === 'annonce') {
            url = `/courses/api/annonces/${currentAnnonceId}/delete/`;
        }

        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken }
        })
        .then(response => response.json())
        .then(result => {
            if (response.ok) {
                if (deleteElementType === 'module') {
                    document.getElementById(`module-item-${currentModuleId}`).remove();
                } else if (deleteElementType === 'ressource') {
                    document.getElementById(`ressource-item-${currentRessourceId}`).remove();
                } else if (deleteElementType === 'evaluation') {
                    document.getElementById(`evaluation-item-${currentEvaluationId}`).remove();
                } else if (deleteElementType === 'annonce') {
                    document.getElementById(`annonce-item-${currentAnnonceId}`).remove();
                }
                deleteConfirmModal.hide();
            } else {
                // Django messages will handle the error display
            }
        })
        .finally(() => {
            spinner.classList.add('d-none');
            confirmDeleteBtn.disabled = false;
        });
    });

    studentTableBody.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-student-btn')) {
            const studentId = e.target.dataset.id;
            // Using native confirm for now, will be replaced by a custom modal later if needed
            if (confirm('Retirer cet étudiant du cours ?')) {
                fetch(`/courses/api/courses/{{ course.id }}/students/${studentId}/remove/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken }
                })
                .then(response => response.json())
                .then(result => {
                    if (response.ok) {
                        document.getElementById(`student-row-${studentId}`).remove();
                    } else {
                        // Django messages will handle the error display
                    }
                });
            }
        }
    });

    // Optionally, add your showToast function here if not already defined

    // --- Gestion des Questions de Quiz ---
    const questionForm = document.getElementById('questionForm');
    const choicesContainer = document.getElementById('choices-container');
    const questionListInModal = document.getElementById('question-list-in-modal');

    function loadQuestionsForQuiz(quizId) {
        questionListInModal.innerHTML = '<li>Chargement...</li>';
        fetch(`/evaluations/api/activities/${quizId}/questions/`)
            .then(response => response.json())
            .then(data => {
                questionListInModal.innerHTML = '';
                if (data.questions && data.questions.length > 0) {
                    data.questions.forEach(question => {
                        const questionItem = document.createElement('li');
                        questionItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        questionItem.innerHTML = `
                            <span>${question.intitule}</span>
                            <div>
                                <button class="btn btn-sm btn-secondary edit-question-btn" data-id="${question.id}">Modifier</button>
                                <button class="btn btn-sm btn-danger delete-question-btn" data-id="${question.id}">Supprimer</button>
                            </div>
                        `;
                        questionListInModal.appendChild(questionItem);
                    });
                } else {
                    questionListInModal.innerHTML = '<li>Aucune question pour ce quiz.</li>';
                }
            });
    }

    document.getElementById('addChoiceBtn').addEventListener('click', function() {
        const choiceIndex = choicesContainer.children.length;
        const choiceHtml = `
            <div class="input-group mb-2">
                <input type="text" class="form-control" name="choice_text_${choiceIndex}" placeholder="Texte de la réponse" required>
                <div class="input-group-text">
                    <input class="form-check-input mt-0" type="checkbox" name="choice_correct_${choiceIndex}">
                </div>
                <button type="button" class="btn btn-outline-danger remove-choice-btn">X</button>
            </div>
        `;
        choicesContainer.insertAdjacentHTML('beforeend', choiceHtml);
    });

    choicesContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-choice-btn')) {
            e.target.closest('.input-group').remove();
        }
    });

    questionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(questionForm);
        const quizId = formData.get('quizId');
        const questionId = formData.get('questionId');
        const url = questionId 
            ? `/evaluations/api/questions/${questionId}/update/`
            : `/evaluations/api/activities/${quizId}/questions/create/`;

        const data = {
            intitule: formData.get('intitule'),
            type_question: formData.get('type_question'),
            choices: []
        };

        let i = 0;
        while(formData.has(`choice_text_${i}`)) {
            data.choices.push({
                text: formData.get(`choice_text_${i}`),
                is_correct: formData.has(`choice_correct_${i}`)
            });
            i++;
        }

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (response.ok) {
                questionForm.reset();
                choicesContainer.innerHTML = '';
                document.getElementById('questionId').value = '';
                loadQuestionsForQuiz(quizId);
            } else {
                const errorDiv = document.getElementById('question-form-errors');
                errorDiv.innerHTML = Object.values(result.errors).map(e => `<p>${e}</p>`).join('');
                errorDiv.classList.remove('d-none');
            }
        });
    });

    document.getElementById('clearQuestionFormBtn').addEventListener('click', function() {
        questionForm.reset();
        choicesContainer.innerHTML = '';
        document.getElementById('questionId').value = '';
    });

    questionListInModal.addEventListener('click', function(e) {
        const questionId = e.target.dataset.id;
        if (e.target.classList.contains('edit-question-btn')) {
            fetch(`/evaluations/api/questions/${questionId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // Django messages will handle the error display
                        return;
                    }
                    questionForm.reset();
                    choicesContainer.innerHTML = '';
                    document.getElementById('questionId').value = data.id;
                    document.getElementById('questionIntitule').value = data.intitule;
                    document.getElementById('questionType').value = data.type_question;
                    data.choix.forEach((choice, index) => {
                        const choiceHtml = `
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" name="choice_text_${index}" value="${choice.texte}" required>
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0" type="checkbox" name="choice_correct_${index}" ${choice.est_correct ? 'checked' : ''}>
                                </div>
                                <button type="button" class="btn btn-outline-danger remove-choice-btn">X</button>
                            </div>
                        `;
                        choicesContainer.insertAdjacentHTML('beforeend', choiceHtml);
                    });
                });
        }
        if (e.target.classList.contains('delete-question-btn')) {
            if (confirm('Supprimer cette question ?')) {
                fetch(`/evaluations/api/questions/${questionId}/delete/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken }
                })
                .then(response => response.json())
                .then(result => {
                    if (response.ok) {
                        // Django messages will handle the success display
                        loadQuestionsForQuiz(document.getElementById('quizId').value);
                    } else {
                        // Django messages will handle the error display
                    }
                });
            }
        }
    });

    // --- Gestion de la Notation des Devoirs ---
    const submissionsList = document.getElementById('submissionsList');

    function loadSubmissionsForGrading(assignmentId) {
        submissionsList.innerHTML = '<li>Chargement des soumissions...</li>';
        fetch(`/evaluations/api/activities/${assignmentId}/submissions/`)
            .then(response => response.json())
            .then(data => {
                submissionsList.innerHTML = '';
                if (data.soumissions && data.soumissions.length > 0) {
                    data.soumissions.forEach(submission => {
                        const submissionItem = document.createElement('div');
                        submissionItem.className = 'card mb-2';
                        submissionItem.innerHTML = `
                            <div class="card-body">
                                <h6 class="card-title">${submission.etudiant_name}</h6>
                                <p class="card-text">Soumis le: ${new Date(submission.date_soumission).toLocaleString()}</p>
                                ${submission.file_url ? `<a href="${submission.file_url}" target="_blank" class="btn btn-sm btn-info">Voir le fichier</a>` : ''}
                                <div class="input-group mt-2">
                                    <span class="input-group-text">Note</span>
                                    <input type="number" step="0.1" class="form-control grade-input" data-submission-id="${submission.id}" value="${submission.note !== null ? submission.note : ''}">
                                    <button class="btn btn-primary save-grade-btn" data-submission-id="${submission.id}">
                                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                        Enregistrer
                                    </button>
                                </div>
                            </div>
                        `;
                        submissionsList.appendChild(submissionItem);
                    });
                } else {
                    submissionsList.innerHTML = '<p>Aucune soumission pour ce devoir.</p>';
                }
            });
    }

    submissionsList.addEventListener('click', function(e) {
        if (e.target.classList.contains('save-grade-btn')) {
            const submissionId = e.target.dataset.submissionId;
            const grade = e.target.previousElementSibling.value;

            fetch(`/evaluations/api/submissions/${submissionId}/grade/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ note: grade })
            })
            .then(response => response.json())
            .then(result => {
                if (response.ok) {
                    // Django messages will handle the success display
                } else {
                    // Django messages will handle the error display
                }
            })
            .finally(() => {
                spinner.classList.add('d-none');
                clickedButton.disabled = false;
            });
        }
    });

    // --- Gestion des Annonces ---
    addAnnonceBtn.addEventListener('click', function () {
        currentAnnonceId = null;
        annonceForm.reset();
        document.getElementById('annonceModalLabel').textContent = 'Ajouter une annonce';
        document.getElementById('annonce-form-errors').classList.add('d-none');
        annonceModal.show();
    });

    saveAnnonceBtn.addEventListener('click', function () {
        // Client-side validation
        if (!annonceForm.checkValidity()) {
            annonceForm.reportValidity();
            return;
        }

        const spinner = saveAnnonceBtn.querySelector('.spinner-border');
        spinner.classList.remove('d-none');
        saveAnnonceBtn.disabled = true;

        const formData = new FormData(annonceForm);
        const data = Object.fromEntries(formData.entries());
        const url = currentAnnonceId
            ? `/courses/api/annonces/${currentAnnonceId}/update/`
            : `/courses/api/courses/${courseId}/annonces/create/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (response.ok) {
                annonceModal.hide();
                upsertAnnonceInList(result.annonce);
            } else {
                const errorDiv = document.getElementById('annonce-form-errors');
                errorDiv.innerHTML = Object.values(result.errors).map(e => `<p>${e}</p>`).join('');
                errorDiv.classList.remove('d-none');
            }
        })
        .finally(() => {
            spinner.classList.add('d-none');
            saveAnnonceBtn.disabled = false;
        });
    });

    function upsertAnnonceInList(annonce) {
        let annonceItem = document.getElementById(`annonce-item-${annonce.id}`);
        const annonceHtml = `
            <div>
                <h5>${annonce.titre}</h5>
                <p>${annonce.contenu.replace(/\n/g, '<br>')}</p>
                <small>Publié le: ${new Date(annonce.cree_le).toLocaleString()}</small>
            </div>
            <div>
                <button class="btn btn-sm btn-secondary edit-annonce-btn" data-id="${annonce.id}">Modifier</button>
                <button class="btn btn-sm btn-danger delete-annonce-btn" data-id="${annonce.id}">Supprimer</button>
            </div>
        `;

        if (annonceItem) {
            annonceItem.innerHTML = annonceHtml;
        } else {
            annonceItem = document.createElement('li');
            annonceItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            annonceItem.id = `annonce-item-${annonce.id}`;
            annonceItem.innerHTML = annonceHtml;
            annonceList.appendChild(annonceItem);
        }
    }

    annonceList.addEventListener('click', function (e) {
        if (e.target.classList.contains('edit-annonce-btn')) {
            const clickedButton = e.target;
            const originalButtonText = clickedButton.innerHTML;
            clickedButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            clickedButton.disabled = true;

            currentAnnonceId = e.target.dataset.id;
            fetch(`/courses/api/annonces/${currentAnnonceId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // Django messages will handle the error display
                        return;
                    }
                    annonceForm.reset();
                    document.getElementById('annonceModalLabel').textContent = 'Modifier une annonce';
                    document.getElementById('annonce-form-errors').classList.add('d-none');
                    
                    document.getElementById('annonceId').value = data.id;
                    document.getElementById('annonceTitre').value = data.titre;
                    document.getElementById('annonceContenu').value = data.contenu;
                    
                    annonceModal.show();
                })
                .finally(() => {
                    clickedButton.innerHTML = originalButtonText;
                    clickedButton.disabled = false;
                });
        }
        if (e.target.classList.contains('delete-annonce-btn')) {
            currentAnnonceId = e.target.dataset.id;
            deleteElementType = 'annonce';
            deleteConfirmModal.show();
        }
    });

    // --- Gestion de l'Inscription Manuelle ---
    enrollStudentBtn.addEventListener('click', function() {
        const list = document.getElementById('enrollable-student-list');
        list.innerHTML = '<li class="list-group-item">Chargement...</li>';
        enrollStudentModal.show();
        fetch(`/courses/api/courses/${courseId}/students/enrollable/`)
            .then(response => response.json())
            .then(data => {
                list.innerHTML = '';
                if (data.students && data.students.length > 0) {
                    data.students.forEach(student => {
                        const item = document.createElement('li');
                        item.className = 'list-group-item d-flex justify-content-between align-items-center';
                        item.innerHTML = `
                            <span>${student.name} (${student.matricule})</span>
                            <button class="btn btn-sm btn-success enroll-now-btn" data-id="${student.id}">Inscrire</button>
                        `;
                        list.appendChild(item);
                    });
                } else {
                    list.innerHTML = '<li class="list-group-item">Tous les étudiants sont déjà inscrits.</li>';
                }
            });
    });

    document.getElementById('enrollable-student-list').addEventListener('click', function(e) {
        if (e.target.classList.contains('enroll-now-btn')) {
            const clickedButton = e.target;
            const originalButtonText = clickedButton.innerHTML;
            clickedButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            clickedButton.disabled = true;

            const studentId = e.target.dataset.id;
            fetch(`/courses/api/courses/${courseId}/students/${studentId}/enroll/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken }
            })
            .then(response => response.json())
        .then(result => {
            if (response.ok) {
                enrollStudentModal.hide();
                addStudentToTable(result.student);
            } else {
                // Django messages will handle the error display
            }
        })
        .finally(() => {
            clickedButton.innerHTML = originalButtonText;
            clickedButton.disabled = false;
        });
        }
    });

    function addStudentToTable(student) {
        const noStudentRow = document.getElementById('no-student-row');
        if (noStudentRow) {
            noStudentRow.remove();
        }
        const newRow = document.createElement('tr');
        newRow.id = `student-row-${student.id}`;
        newRow.innerHTML = `
            <td>${student.last_name} ${student.first_name}</td>
            <td>${student.email}</td>
            <td>${student.matricule}</td>
            <td>
                <button class="btn btn-sm btn-danger remove-student-btn" data-id="${student.id}">Retirer</button>
            </td>
        `;
        studentTableBody.appendChild(newRow);
    }
});
</script>
{% endblock %}